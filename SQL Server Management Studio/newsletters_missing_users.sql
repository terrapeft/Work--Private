use backoffice

-- users (trigger INSERT_Repl_LogonUsers_Tr2)

insert into Interim.[LogonUsers_Stage] ([UserId],[UserName],[EncryptPassword],[IsLockedOut],[UserTypeId],[ActionCode],[ProcessNum])
select userid, username, right(newid(),10), islockedout, UserTypeId, 'I', 0 
from logon.Users
where userid in (
		128279 -- BACO-592
		,1154343,734749,1097568,1188770,1702440,1093987,1788129,1812989,1798914,2641036,1599090,2598548,1911454,972920,1006000,728740,1894844,1025028,1020363,2170529,965737,2377867,976612,1112576,2303324,2116665,1832120,1894857,2181238,2461434,2045447,2210650,1925220,1910351,1738375,1042619,1823990,1922675,1577923,2291043,1106792,1109008,911350,2331974,652767,2417624,1764395,1514879,2244088,2652334,1180215,2452928,2246813,2461545,1019120,2482803,944995,1085496,915278,2598502,1205976,2014797,1594676,2026731,2493879,2247596,60104,755797,2459020,2018590,973023,1907975,2466636,1153621,1810693,2231454,2058374,1764386,2439496,5206434,1688518,719476,1924590,1935362,1774266,2399104,1617894,1143876,1735638,2492667,2203563,1912144,2262276,1716311,1047485,1737826,1748460,1720778 --BACO-591
		,474769 -- BACO-590 622
		,394176,716269,1077872,1078454,1091724,1812989,2200170,2212096,2234374,2249791,2279960,2199595,2208367,2212316,2216778,2222095,2227400,2229280,2236905,1801399,1831351,1084895,1096404,2188526,2191732,2216753,2218597,2221619,2246813,2249145,1827256,1833597,1841332,1085496,2199346,2204312,2208789,2212837,2227456,2228039,2258194,2277788,1093987,1116443,707507,972920,2034146,2052684,2062740,2067949,2082721,2106060,2598529,2598568,2598595,2598660,2613538,2614122,2648548,2042593,2067408,2071719,2107530,2113726,2598502,2598527,2598542,2598570,2598609,2598618,2598626,2598664,2598689,2622583,2631721,2017695,2031760,2034175,968921,1576897,907171,916773,924086,2056349,2112581,2598537,2598548,2598632,2598682,2598708,2601534,2631741,2632510,2016342,2017019,2041380,1547687,1550382,2598540,2598590,2598596,2598606,2598607,2598611,2598620,2598621,2598658,2598681,2605733,2621818,2631304,2631554,2632150,2015663,2015791,2022048,2034238,2098024,2102647,2106671,2112443,2113059,128279,592732,2120891,2143528,2146115,2146889,2156477,2174003,2174021,2507787,2569379,2143131,2167553,2174806,2572914,1247139,2116364,2116665,2122137,2127536,1227592,1235258,1237216,574168,2145781,2155526,2162533,2171274,2577940,1437145,2133843,2133929,2138817,1243477,2136358,2181386,2578695,1416697,2117472,60104,819218,835456,1173134,1730524,1752257,1764386,1764412,1764445,1764533,1764537,1784076,2293841,2301666,2315757,2316013,2323458,2336930,2664312,2680734,2680829,2680989,2683190,2683635,5010435,1777715,1787573,2290044,2292490,2293214,2295256,2297626,2303729,2306068,2315770,2318377,2318458,2323487,2330268,2334210,2350085,2659629,2661760,2679527,2680542,2682640,2683201,2683620,1712780,1720696,1748294,1748319,1764424,1764530,840904,5035698,2348095,2681193,2682632,2683412,2302731,2319314,2323460,2324217,2327201,1731881,1732565,1764544,842435,5008149,2290605,2291382,2293414,2297513,2315781,2327823,2336082,2344248,2662963,2675732,2680674,2681050,2681570,2683188,2683351,2683388,2683422,1749185,1142018,1143876,1180215,1189986,1194145,835665,875575,744461,790171,1513828,1514891,1882623,1888000,1897650,1912109,1921919,1923354,2356264,2376029,2388933,2400322,2404331,2407017,2410341,2412536,2358023,2377867,2396874,2398448,2427242,2431152,1872099,1882565,1882575,1882584,1882602,1882604,1888493,794349,799755,728740,2399047,2403515,2406810,2407007,2407018,2412335,2414149,2421142,2427408,2428335,1909842,1910351,1912141,1937722,1939568,2359470,1869369,1882625,1891533,1893950,1900738,815653,1514941,753942,753967,2400273,2404717,2407030,2407031,2411366,2415375,2423086,1920924,2374462,1894857,1901423,1514904,1514970,735612,1006417,1006438,1018172,1019971,1688106,1690988,2440998,2463488,2477775,2483291,2490100,2491264,2483750,2491295,2491306,2498347,2502357,2441934,2451169,2453732,1697598,985465,2486067,2490108,2491313,2492667,2493117,2494714,2496947,2499751,2500454,2438323,2438451,2451739,2460918,1666971,1023652,1043050,985934,2471282,2486706,2490096,2490098,2490099,2498618,2451185,2455633,2456887,1955731,1023710,981600 -- BACO-590 695

)


-- [Customer].[Insert_Repl_ContactPref_Tr2]

INSERT INTO Interim.[ContactPref_Stage] ([UserId],[UserContactPermissionTypeId],[SubscriptionAllowed],[EditorialAllowed],[MarketingAllowed],[ActionCode])
SELECT [UserId],[UserContactPermissionTypeId],[SubscriptionAllowed],[EditorialAllowed],[MarketingAllowed], 'I' 
FROM Customer.UserContactPreferences
where userid in (
		128279 -- BACO-592
		,1154343,734749,1097568,1188770,1702440,1093987,1788129,1812989,1798914,2641036,1599090,2598548,1911454,972920,1006000,728740,1894844,1025028,1020363,2170529,965737,2377867,976612,1112576,2303324,2116665,1832120,1894857,2181238,2461434,2045447,2210650,1925220,1910351,1738375,1042619,1823990,1922675,1577923,2291043,1106792,1109008,911350,2331974,652767,2417624,1764395,1514879,2244088,2652334,1180215,2452928,2246813,2461545,1019120,2482803,944995,1085496,915278,2598502,1205976,2014797,1594676,2026731,2493879,2247596,60104,755797,2459020,2018590,973023,1907975,2466636,1153621,1810693,2231454,2058374,1764386,2439496,5206434,1688518,719476,1924590,1935362,1774266,2399104,1617894,1143876,1735638,2492667,2203563,1912144,2262276,1716311,1047485,1737826,1748460,1720778 --BACO-591
	)

except -- those who are already there

SELECT [UserId],[UserContactPermissionTypeId],[SubscriptionAllowed],[EditorialAllowed],[MarketingAllowed], 'I' 
FROM Interim.[ContactPref_Stage]

where userid in (
		128279 -- BACO-592
		,1154343,734749,1097568,1188770,1702440,1093987,1788129,1812989,1798914,2641036,1599090,2598548,1911454,972920,1006000,728740,1894844,1025028,1020363,2170529,965737,2377867,976612,1112576,2303324,2116665,1832120,1894857,2181238,2461434,2045447,2210650,1925220,1910351,1738375,1042619,1823990,1922675,1577923,2291043,1106792,1109008,911350,2331974,652767,2417624,1764395,1514879,2244088,2652334,1180215,2452928,2246813,2461545,1019120,2482803,944995,1085496,915278,2598502,1205976,2014797,1594676,2026731,2493879,2247596,60104,755797,2459020,2018590,973023,1907975,2466636,1153621,1810693,2231454,2058374,1764386,2439496,5206434,1688518,719476,1924590,1935362,1774266,2399104,1617894,1143876,1735638,2492667,2203563,1912144,2262276,1716311,1047485,1737826,1748460,1720778 --BACO-591
	)


-- [Customer].[Repl_Insert_UCA_Tr2]

declare @addrId int
declare @userId int
declare @pId int
DECLARE @UCAId as INT

declare mycursor cursor 
for 
	select U.addressid as aid, [aUID], usa.ParentusercontactaddressID as pid, usa.usercontactaddressid
	from [Interim].[Addresses_ReplTest] A
	join Interim.[UserContactAddress_Stage] U 
	on A.auid = U.UserId --and A.aid = U.AddressId
	join Customer.USerContactAddress USA ON USA.UserContactaddressId = U.ParentUserContactaddressId and USA.userid = U.UserID and USA.addressid = 0 
	full outer join [newcentralusers].[dbo].[userdetails] ud on auid = ud.uid
	where ud.uid is null and u.addressid != 0 and auid in (
		128279 -- BACO-592
		,1154343,734749,1097568,1188770,1702440,1093987,1788129,1812989,1798914,2641036,1599090,2598548,1911454,972920,1006000,728740,1894844,1025028,1020363,2170529,965737,2377867,976612,1112576,2303324,2116665,1832120,1894857,2181238,2461434,2045447,2210650,1925220,1910351,1738375,1042619,1823990,1922675,1577923,2291043,1106792,1109008,911350,2331974,652767,2417624,1764395,1514879,2244088,2652334,1180215,2452928,2246813,2461545,1019120,2482803,944995,1085496,915278,2598502,1205976,2014797,1594676,2026731,2493879,2247596,60104,755797,2459020,2018590,973023,1907975,2466636,1153621,1810693,2231454,2058374,1764386,2439496,5206434,1688518,719476,1924590,1935362,1774266,2399104,1617894,1143876,1735638,2492667,2203563,1912144,2262276,1716311,1047485,1737826,1748460,1720778 --BACO-591
	)

open mycursor
fetch next from mycursor into @addrId, @userId, @pId, @UCAId
while @@fetch_status = 0
begin
	-- from trigger:
	IF  EXISTS (SELECT 1 FROM INTERIM.AddressUCAMap where userid = @userId AND usercontactaddressID = @pid)
		BEGIN -- BEgin For IF EXISTS

			UPDATE INTERIM.AddressUCAMap
			SET usercontactaddressID = @UCAId
			WHERE usercontactaddressID = @pid AND  userid = @userId

		END -- END For IF EXISTS

	ELSE
	--IF NOT EXISTS (SELECT 1 FROM INTERIM.AddressUCAMap where userid = @uid AND usercontactaddressID = @pid)
	BEGIN

		INSERT INTO INTERIM.AddressUCAMap 
		SELECT @userId, @addrid, @ucaid

	END

	fetch next from mycursor into @addrId, @userId, @pId, @UCAId


end
close mycursor
deallocate mycursor


